import{u as fe,a as Q,S as f,j as e,M as X,b as ee,c as me}from"./index-7LPLAlBg.js";import{r as x,d as ge}from"./vendor-react-D64xOC9_.js";import{S as he}from"./SchemaDocumentation-CqOaykNn.js";import{I as ke,V as we,aE as ye,aF as te,m as _e,e as je,d as ve}from"./vendor-icons-Du2dXQHa.js";const _=me("RecordDetail"),Re=({isOpen:m,onClose:re,items:n,initialIndex:F=0,title:ae,tableName:g,schema:T})=>{const{t:s}=fe(),[u,Y]=x.useState(F),[S,z]=x.useState(null),[w,W]=x.useState(null),[O,C]=x.useState(!1),[j,y]=x.useState(!1),[i,p]=x.useState(null),[se,I]=x.useState(null),[v,R]=x.useState(null),[D,U]=x.useState(!1),[le]=Q("worklist_default_priority","normal"),[Z]=Q("worklist_default_due_days",0),M=ae||s("record_detail.title"),h=g||"unknown",$=!!(g&&g!=="unknown"),P=ge.useRef(!1);x.useEffect(()=>{if(!m){P.current=!1;return}if(m&&!P.current&&n&&n.length>0){const t=Math.max(0,F);Y(t),W(t),z(null),C(!1),P.current=!0}},[m,F,n]),x.useEffect(()=>{if(m){if(T){R(T);return}g&&g!=="unknown"?(async()=>{const r=await f.getTableSchema(g);if(r&&r.length>0){const a={title:`${s("datasource.tab_structure")}: ${g}`,description:s("datasource.user_tables_hint"),type:"object",properties:r.reduce((l,d)=>(l[d.name]={type:d.type.toLowerCase().includes("int")||d.type.toLowerCase().includes("real")?"number":"string",description:`${d.name} (${d.type})`},l),{})};R(a)}else R(null)})():R(null)}},[m,g,T,s]);const V=x.useCallback(async t=>{if(!t)return null;try{const d=(await f.getTableSchema(h)).find(b=>b.pk===1)?.name;if(d&&t[d]!==void 0&&t[d]!==null){const b=t[d];if(typeof b=="string"||typeof b=="number")return b}}catch{}if(t._rowid!==void 0&&t._rowid!==null){const l=t._rowid;if(typeof l=="string"||typeof l=="number")return l}const r=Object.keys(t).find(l=>l.toLowerCase()==="id"||l.toLowerCase()==="entryid"||l.toLowerCase()==="rowid");if(r&&t[r]!==void 0&&t[r]!==null){const l=t[r];if(typeof l=="string"||typeof l=="number")return l}const a=Object.keys(t).find(l=>l.toLowerCase().endsWith("_id")||l.toLowerCase().endsWith("id"));if(a&&t[a]!==void 0&&t[a]!==null){const l=t[a];if(typeof l=="string"||typeof l=="number")return l}return null},[h]);x.useEffect(()=>{m&&(async()=>{const r=n[u];if(r){if(!$){I(null),y(!1),p(null);return}const a=await V(r);if(a===null){I(null),y(!1),p(null);return}const l=await f.getRecordMetadata(h,a??"");y(l.isInWorklist),p(l.worklistItem),I(l.exists)}else I(null),p(null),y(!1)})()},[m,u,n,h,$,V]);const oe=async()=>{if(D||!$)return;const t=n[u],r=await V(t);if(!r){_.warn("Cannot toggle worklist: No unique ID found for record",t);return}U(!0);try{if(j)await f.executeRaw("DELETE FROM sys_worklist WHERE source_table = ? AND source_id = ?",[h,r]),y(!1),p(null);else{const a=c=>{if(c===null)return null;const o=c.trim().toLowerCase();return o==="low"||o==="normal"||o==="high"||o==="critical"?o:"normal"},l=c=>{if(c===null)return null;const o=c.trim();return o&&/^\d{4}-\d{2}-\d{2}$/.test(o)?o:""},d=()=>{if(Z<=0)return"";const c=new Date;c.setDate(c.getDate()+Z);const o=c.getFullYear(),N=String(c.getMonth()+1).padStart(2,"0"),pe=String(c.getDate()).padStart(2,"0");return`${o}-${N}-${pe}`},b=await ee.prompt(s("worklist.add_priority_prompt","Prioritaet (low, normal, high, critical)"),{title:s("worklist.add_dialog_title","Zum Arbeitsvorrat"),defaultValue:le});if(b===null)return;const k=a(b)??"normal",B=await ee.prompt(s("worklist.add_due_prompt","Faelligkeit optional (YYYY-MM-DD), leer lassen fuer keine"),{title:s("worklist.add_dialog_title","Zum Arbeitsvorrat"),defaultValue:d()});if(B===null)return;const L=l(B),ce=L===""?null:L,ue=["name","title","description","label","display_name","VendorName","Description"];let A="";for(const c of ue){const o=Object.keys(t).find(N=>N.toLowerCase()===c.toLowerCase());if(o&&t[o]){A=String(t[o]);break}}A||(A=s("worklist.entry_id",{id:r}));const be=["period","fiscalyear","category","type","group","Period"];let J=h;for(const c of be){const o=Object.keys(t).find(N=>N.toLowerCase()===c.toLowerCase());if(o&&t[o]){J=String(t[o]);break}}await f.executeRaw("INSERT INTO sys_worklist (source_table, source_id, display_label, display_context, priority, due_at) VALUES (?, ?, ?, ?, ?, ?)",[h,r,A,J,k,ce]);const xe=await f.getRecordMetadata(h,r);y(!0),p(xe.worklistItem)}window.dispatchEvent(new Event("db-changed"))}catch(a){_.error("Failed to toggle worklist status",a)}finally{U(!1)}},ne=()=>{W(w===u?null:u)},H=t=>{z(u),Y(t)};if(!n||n.length===0)return null;const q=n[u],G=w!==null?n[w]:S!==null&&S>=0&&S<n.length?n[S]:null,E=w!==null,K=w===u;if(!q)return null;const ie=t=>{if(t==null)return null;const r=String(t).trim();if(!r)return null;const a=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,l=/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,d=/^[A-Z]{2}\d{2}[A-Z0-9]{10,30}$/i,b=/^https?:\/\/[^\s/$.?#].[^\s]*$/i,k=(()=>{if(!(/^\d{4}-\d{2}-\d{2}/.test(r)||/^\d{2}[./-]\d{2}[./-]\d{2,4}$/.test(r)))return!1;const L=Date.parse(r.replace(/\./g,"-"));return!Number.isNaN(L)})();return a.test(r)?"email":l.test(r)?"uuid":d.test(r)?"iban":b.test(r)?"url":k?"date":null},de=t=>{if(t==null)return!1;const r=String(t);if(!r.trim())return!1;let a=!1;for(let b=0;b<r.length;b++){const k=r.charCodeAt(b);if(k<32&&k!==9&&k!==10&&k!==13){a=!0;break}}const l=r.length>256&&!/\s/.test(r),d=/<script|javascript:/i.test(r);return a||l||d};return e.jsxs(e.Fragment,{children:[e.jsx(X,{isOpen:m,onClose:re,title:n.length>1?`${M} (${u+1} / ${n.length})`:M,noScroll:!0,children:e.jsxs("div",{className:"flex flex-col h-full min-h-0 bg-white dark:bg-slate-800",children:[e.jsxs("div",{className:"shrink-0 px-6 py-3 bg-slate-50 dark:bg-slate-900/50 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between z-20",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[v&&e.jsx("button",{onClick:()=>C(!0),className:"p-1.5 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors text-slate-500",title:s("record_detail.schema_definition"),children:e.jsx(ke,{className:"w-4 h-4"})}),$&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:oe,disabled:D,className:`p-1.5 rounded-lg border transition-colors flex items-center gap-1.5 ${D?"opacity-50 cursor-not-allowed":""} ${j?"bg-amber-50 border-amber-200 text-amber-600 dark:bg-amber-900/20 dark:border-amber-800 dark:text-amber-400":"bg-white border-slate-300 text-slate-500 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:hover:bg-slate-700"}`,title:s(j?"record_detail.remove_worklist":"record_detail.add_worklist"),children:D?e.jsx(we,{className:"w-4 h-4 animate-spin"}):e.jsx(ye,{className:`w-4 h-4 ${j?"fill-current":""}`})}),e.jsx("div",{className:"h-4 w-[1px] bg-slate-200 dark:bg-slate-700 mx-1"})]}),e.jsxs("button",{onClick:ne,className:`p-1.5 rounded-lg border transition-colors flex items-center gap-1.5 group relative ${E?"bg-blue-50 border-blue-200 text-blue-600 dark:bg-blue-900/20 dark:border-blue-800 dark:text-blue-400":"bg-white border-slate-300 text-slate-500 hover:bg-slate-50 dark:bg-slate-800 dark:border-slate-700 dark:hover:bg-slate-700"}`,title:s(K?"record_detail.clear_reference":"record_detail.set_reference"),children:[e.jsx(te,{className:`w-4 h-4 ${E?"fill-current":""}`}),E&&!K&&e.jsxs("span",{className:"absolute -top-1 -right-1 flex h-2.5 w-2.5",children:[e.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"}),e.jsx("span",{className:"relative inline-flex rounded-full h-2.5 w-2.5 bg-blue-500"})]})]}),e.jsx("div",{className:"h-4 w-[1px] bg-slate-200 dark:bg-slate-700 mx-1"}),e.jsx("div",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest px-2",children:s("record_detail.navigation")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[se===!1&&e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800 rounded-lg text-[10px] font-black animate-pulse",children:[e.jsx(_e,{className:"w-3.5 h-3.5"})," ",s("record_detail.deleted_badge")]}),e.jsx("button",{disabled:u===0,onClick:()=>H(u-1),className:"p-1.5 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 disabled:opacity-30 disabled:cursor-not-allowed hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors",children:e.jsx(je,{className:"w-4 h-4"})}),e.jsxs("div",{className:"text-[11px] font-black text-slate-700 dark:text-slate-200 min-w-[60px] text-center bg-white dark:bg-slate-800 px-2 py-1 rounded-md border border-slate-200 dark:border-slate-800 shadow-sm",children:[u+1," / ",n.length]}),e.jsx("button",{disabled:u===n.length-1,onClick:()=>H(u+1),className:"p-1.5 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 disabled:opacity-30 disabled:cursor-not-allowed hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors",children:e.jsx(ve,{className:"w-4 h-4"})})]})]}),j&&e.jsx("div",{className:"shrink-0 px-6 py-4 bg-amber-50/30 dark:bg-amber-900/5 border-b border-slate-200 dark:border-slate-700 space-y-3",children:e.jsxs("div",{className:"flex items-start gap-4 flex-wrap",children:[e.jsxs("div",{className:"w-48 shrink-0",children:[e.jsx("label",{className:"block text-[9px] font-black uppercase text-amber-600 dark:text-amber-400 mb-1.5 px-1",children:s("record_detail.status_label")}),e.jsxs("select",{value:typeof i?.status=="string"?i.status:"open",onChange:async t=>{if(i){const r=t.target.value;p(a=>a&&{...a,status:r});try{await f.updateWorklistItem(i.id,{status:r})}catch(a){_.error("Failed to update status",a)}}},className:"w-full p-2 bg-white dark:bg-slate-800 border border-amber-200 dark:border-amber-900/50 rounded-xl text-xs font-bold text-slate-800 dark:text-slate-100 outline-none focus:ring-2 focus:ring-amber-500/20 transition-all cursor-pointer",children:[e.jsx("option",{value:"open",children:s("worklist.status_open","Neu / Offen")}),e.jsx("option",{value:"in_progress",children:s("worklist.status_in_progress","In Bearbeitung")}),e.jsx("option",{value:"done",children:s("worklist.status_done","Erledigt")}),e.jsx("option",{value:"closed",children:s("worklist.status_closed","Geschlossen")})]})]}),e.jsxs("div",{className:"w-48 shrink-0",children:[e.jsx("label",{className:"block text-[9px] font-black uppercase text-amber-600 dark:text-amber-400 mb-1.5 px-1",children:s("worklist.priority_label","Prioritaet")}),e.jsxs("select",{value:typeof i?.priority=="string"?i.priority:"normal",onChange:async t=>{if(i){const r=t.target.value;p(a=>a&&{...a,priority:r});try{await f.updateWorklistItem(i.id,{priority:r})}catch(a){_.error("Failed to update priority",a)}}},className:"w-full p-2 bg-white dark:bg-slate-800 border border-amber-200 dark:border-amber-900/50 rounded-xl text-xs font-bold text-slate-800 dark:text-slate-100 outline-none focus:ring-2 focus:ring-amber-500/20 transition-all cursor-pointer",children:[e.jsx("option",{value:"low",children:s("worklist.priority_low","Niedrig")}),e.jsx("option",{value:"normal",children:s("worklist.priority_normal","Normal")}),e.jsx("option",{value:"high",children:s("worklist.priority_high","Hoch")}),e.jsx("option",{value:"critical",children:s("worklist.priority_critical","Kritisch")})]})]}),e.jsxs("div",{className:"w-48 shrink-0",children:[e.jsx("label",{className:"block text-[9px] font-black uppercase text-amber-600 dark:text-amber-400 mb-1.5 px-1",children:s("worklist.due_label","Faellig")}),e.jsx("input",{type:"date",value:typeof i?.due_at=="string"?i.due_at.slice(0,10):"",onChange:async t=>{if(i){const r=t.target.value||null;p(a=>a&&{...a,due_at:r});try{await f.updateWorklistItem(i.id,{due_at:r})}catch(a){_.error("Failed to update due date",a)}}},className:"w-full p-2 bg-white dark:bg-slate-800 border border-amber-200 dark:border-amber-900/50 rounded-xl text-xs font-bold text-slate-800 dark:text-slate-100 outline-none focus:ring-2 focus:ring-amber-500/20 transition-all cursor-pointer"})]}),e.jsxs("div",{className:"flex-1 min-w-[320px]",children:[e.jsx("label",{className:"block text-[9px] font-black uppercase text-amber-600 dark:text-amber-400 mb-1.5 px-1",children:s("record_detail.comment_label")}),e.jsx("textarea",{value:typeof i?.comment=="string"?i.comment:"",onChange:t=>p(r=>r&&{...r,comment:t.target.value}),onBlur:async t=>{if(i)try{await f.updateWorklistItem(i.id,{comment:t.target.value})}catch(r){_.error("Failed to update comment",r)}},placeholder:s("record_detail.comment_placeholder"),className:"w-full p-2 h-[88px] bg-white dark:bg-slate-800 border border-amber-200 dark:border-amber-900/50 rounded-xl text-xs font-medium text-slate-800 dark:text-slate-100 placeholder:text-slate-400 dark:placeholder:text-slate-500 outline-none focus:ring-2 focus:ring-amber-500/20 transition-all resize-none"})]})]})}),e.jsxs("div",{className:"flex-1 overflow-auto p-6 pt-4 min-h-0 scrollbar-thin scrollbar-thumb-slate-200 dark:scrollbar-thumb-slate-700",children:[E&&!K&&e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/30 rounded-lg px-3 py-2 text-[10px] text-blue-700 dark:text-blue-300 flex items-center gap-2 mb-6",children:[e.jsx(te,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"font-bold",children:s("record_detail.comparison_active")}),e.jsx("span",{children:s("record_detail.differences_relative",{id:n[w].id||w+1})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6",children:Object.entries(q).map(([t,r])=>{if(t.startsWith("is")||t==="compositeKey"||t==="status")return null;const a=G&&String(r)!==String(G[t]);return e.jsxs("div",{className:`
                                            border-b border-slate-100 dark:border-slate-700/50 pb-2 transition-colors duration-500
                                            ${a?"bg-amber-50 dark:bg-amber-900/20 -mx-2 px-2 rounded-lg border-amber-200 dark:border-amber-800 shadow-sm":""}
                                        `,children:[e.jsxs("dt",{className:"text-[10px] font-bold uppercase text-slate-400 mb-1 flex items-center justify-between tracking-wider",children:[t,a&&e.jsx("span",{className:"text-[9px] bg-amber-200 dark:bg-amber-800 text-amber-800 dark:text-amber-200 px-1.5 rounded-full font-black",children:"DIFF"})]}),e.jsx("dd",{className:`text-sm font-semibold break-all ${a?"text-amber-900 dark:text-amber-100":"text-slate-900 dark:text-white"}`,children:r==null||r===""?e.jsx("span",{className:"text-slate-300 italic",children:s("record_detail.empty_value")}):e.jsxs("div",{className:"flex flex-wrap items-start gap-2",children:[e.jsx("span",{children:String(r)}),(()=>{const l=ie(r);return l?e.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 rounded-full border border-indigo-200 bg-indigo-50 text-indigo-700 text-[10px] font-black uppercase tracking-wide",children:s(`record_detail.pattern_${l}`)}):null})(),de(r)&&e.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 rounded-full border border-amber-200 bg-amber-50 text-amber-700 text-[10px] font-black uppercase tracking-wide",children:s("record_detail.suspicious")})]})})]},t)})})]})]})}),v&&O&&e.jsx(X,{isOpen:O,onClose:()=>C(!1),title:v.title||M,children:e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400 italic",children:v.description}),e.jsx(he,{schema:v}),e.jsx("button",{onClick:()=>C(!1),className:"w-full py-2.5 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-xl font-bold text-xs transition-opacity hover:opacity-90 mt-4",children:s("record_detail.close")})]})})]})};export{Re as R};
